<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∏ –î–æ—Å—Ç–∞–≤–∫–∞ | –ö–≤—ñ—Ç–∏ CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.08); 
            width: 100%; 
            max-width: 450px; 
            border-top: 6px solid #ffafbd;
        }
        h2 { 
            text-align: center; 
            color: #444; 
            margin-bottom: 10px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 12px;
            font-size: 22px;
        }
        h2 i.fa-seedling { color: #81c784; }
        h2 i.fa-truck { color: #ffafbd; }
        
        .order-id-display { 
            text-align: center; 
            color: #888; 
            font-weight: bold; 
            background: #f8f9fa; 
            padding: 8px; 
            border-radius: 25px; 
            margin-bottom: 25px;
            font-size: 0.9em;
        }
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            color: #555; 
            font-weight: 600; 
            font-size: 14px;
        }
        input { 
            width: 100%; 
            padding: 14px; 
            border: 1px solid #eee; 
            border-radius: 12px; 
            font-size: 16px; 
            box-sizing: border-box; 
            transition: 0.3s;
            background: #fafafa;
        }
        input:focus {
            border-color: #ffafbd;
            outline: none;
            background: #fff;
            box-shadow: 0 0 10px rgba(255,175,189,0.2);
        }
        button { 
            width: 100%; 
            padding: 16px; 
            background: linear-gradient(to right, #ffc3a0, #ffafbd); 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 18px; 
            font-weight: bold;
            cursor: pointer; 
            transition: 0.4s; 
            margin-top: 10px; 
            box-shadow: 0 4px 15px rgba(255,175,189,0.4);
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,175,189,0.6);
        }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .status { text-align: center; margin-top: 15px; font-weight: bold; }

        /* Select2 Custom Styles */
        .select2-container .select2-selection--single { 
            height: 50px; 
            border: 1px solid #eee; 
            border-radius: 12px; 
            background: #fafafa;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered { 
            line-height: 50px; 
            padding-left: 15px; 
            color: #444;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: 48px; }
    </style>
</head>
<body>

<div class="container">
    <h2><i class="fas fa-seedling"></i> üöö <i class="fas fa-spa"></i> –î–æ—Å—Ç–∞–≤–∫–∞</h2>
    <div class="order-id-display" id="orderIdDisplay">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

    <form id="deliveryForm">
        <div class="form-group">
            <label>–ü—Ä—ñ–∑–≤–∏—â–µ –Ü–º'—è –ü–æ –±–∞—Ç—å–∫–æ–≤—ñ</label>
            <input type="text" id="fio" placeholder="–ü–Ü–ë –æ—Ç—Ä–∏–º—É–≤–∞—á–∞" required>
        </div>

        <div class="form-group">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="tel" id="phone" placeholder="0XXXXXXXXX" required>
        </div>

        <div class="form-group">
            <label>–ú—ñ—Å—Ç–æ (–ø–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É)</label>
            <select id="citySelect" style="width: 100%;" required>
                <option value="">–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ...</option>
            </select>
        </div>

        <div class="form-group">
            <label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏</label>
            <select id="branchSelect" style="width: 100%;" disabled required>
                <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</option>
            </select>
        </div>

        <button type="submit" id="submitBtn">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —Ç–∞ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
    </form>
    <div id="statusMessage" class="status"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
    const WORKER_URL = 'https://ajodostavka.brelok2023.workers.dev/'; 
    
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('id');
    
    let selectedCityRef = '';
    let selectedBranchRef = '';

    $(document).ready(function() {
        if (!orderId) {
            document.body.innerHTML = '<h2 style="text-align:center; margin-top:50px;">‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–µ–≤—ñ—Ä–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è.</h2>';
            return;
        }
        $('#orderIdDisplay').text(`–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ: ${orderId}`);

        // 1. –ü–û–ò–°–ö –ì–û–†–û–î–ê
        $('#citySelect').select2({
            placeholder: "–í–≤–µ–¥—ñ—Ç—å –º—ñ—Å—Ç–æ...",
            minimumInputLength: 2,
            language: {
                inputTooShort: function() {
                    return "–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ —Ö–æ—á–∞ –± 2 –ª—ñ—Ç–µ—Ä–∏"; // –ò–ª–∏ –ø–æ-—Ä—É—Å—Å–∫–∏: "–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 –±—É–∫–≤—ã"
                },
                searching: function() {
                    return "–®—É–∫–∞—î–º–æ..."; // "–ò—â–µ–º..."
                },
                noResults: function() {
                    return "–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"; // "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
                }
            },
            ajax: {
                url: WORKER_URL,
                type: 'POST',
                dataType: 'json',
                delay: 400,
                contentType: 'application/json',
                data: function (params) {
                    return JSON.stringify({ action: 'search_city', term: params.term });
                },
                processResults: function (data) {
                    if (data.status === 'success' && data.data) return { results: data.data };
                    return { results: [] };
                }
            }
        });
        // ... —Ç–≤–æ–π –∫–æ–¥ –¥–ª—è –≥–æ—Ä–æ–¥–∞ (citySelect) –∑–∞–∫–æ–Ω—á–∏–ª—Å—è —Ç—É—Ç ...
    
    // --- –í–°–¢–ê–í–õ–Ø–ô –°–Æ–î–ê ---
    $('#branchSelect').select2({
        placeholder: "–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ",
        disabled: true,  // <--- –í–û–¢ –ì–õ–ê–í–ù–û–ï: –û–Ω–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã–º!
        width: '100%'    // –ß—Ç–æ–±—ã —à–∏—Ä–∏–Ω–∞ –±—ã–ª–∞ —Ç–æ—á–Ω–æ —Ç–∞–∫–∞—è –∂–µ, –∫–∞–∫ —É –≥–æ—Ä–æ–¥–∞
    });
    // ---------------------

    // 2. –í–´–ë–û–† –û–¢–î–ï–õ–ï–ù–ò–Ø (–¥–∞–ª—å—à–µ –∏–¥–µ—Ç —Ç–≤–æ–π —Å—Ç–∞—Ä—ã–π –∫–æ–¥...)

        // 2. –í–´–ë–û–† –û–¢–î–ï–õ–ï–ù–ò–Ø
        $('#citySelect').on('select2:select', function (e) {
            selectedCityRef = e.params.data.id; 
            $('#branchSelect').prop('disabled', true).empty().append('<option>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–¥—ñ–ª–µ–Ω—å...</option>');
            
            fetch(WORKER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'get_branches', city_ref: selectedCityRef })
            })
            .then(res => res.json())
            .then(response => {
                $('#branchSelect').empty().append('<option value="">–û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è...</option>');
                if(response.status === 'success') {
                    response.data.forEach(branch => {
                        $('#branchSelect').append(`<option value="${branch.id}">${branch.text}</option>`);
                    });
                    $('#branchSelect').prop('disabled', false).select2();
                }
            })
            .catch(err => {
                console.error(err);
                $('#branchSelect').empty().append('<option value="">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</option>');
            });
        });

        $('#branchSelect').on('change', function() {
            selectedBranchRef = $(this).val();
        });

        // 3. –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–•
        $('#deliveryForm').on('submit', async function(e) {
            e.preventDefault();
            const btn = $('#submitBtn');
            const status = $('#statusMessage');
            
            btn.prop('disabled', true).text('–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...');
            status.text('');

            const payload = {
                action: 'update_delivery',
                order_id: orderId,
                fio: $('#fio').val().trim(),
                phone: $('#phone').val().trim(),
                city: $('#citySelect option:selected').text(),
                branch: $('#branchSelect option:selected').text(),
                ref_data: {
                    city_ref: selectedCityRef,
                    branch_ref: selectedBranchRef
                }
            };

            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.status === 'success') {
                    document.body.innerHTML = `
                        <div class="container" style="text-align:center;">
                            <h1 style="color:#ffafbd; font-size: 60px; margin-bottom:10px;">üå∏</h1>
                            <h2 style="color:#333;">–î—è–∫—É—î–º–æ!</h2>
                            <p style="color:#666;">–î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –æ—Ç—Ä–∏–º–∞–Ω—ñ. –ú–∏ –≤–∂–µ –∑–±–∏—Ä–∞—î–º–æ –≤–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è!</p>
                        </div>
                    `;
                } else {
                    status.css('color', 'red').text('–ü–æ–º–∏–ª–∫–∞: ' + result.message);
                    btn.prop('disabled', false).text('–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑');
                }
            } catch (error) {
                status.css('color', 'red').text('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º.');
                btn.prop('disabled', false).text('–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑');
            }
        });
    });
</script>

</body>
</html>
